# cron entry for obnam host profile
#
# We do regular backup and some housekeeping to keep the backup storage usage under control.
#
# If an obnam backup run fails, it leaves a stray lockfile we therefore try a
# backup which exits after some timeout if it cannot get the lock. In this case
# we force lock acquiring and then run the backup again.
#
# As we do forcefully acquire the obnam lock after some timeout to recover from failures, ensure
# that we do not run two instances of the same obnam profile by using a sensible schedule.

SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
MAILTO=root
HOME=/

OBNAM="obnam --config /etc/obnam/host.profile"
<%= cron_minute %> 22 * * * root $OBNAM forget
<%= cron_minute %> <%= cron_hour %> * * * root $OBNAM backup || ( $OBNAM force-lock && $OBNAM backup )
